# 技能Hook项目开发规范

## 1. 项目概述

本项目是一个基于 Frida 的游戏技能 Hook 系统，使用 TypeScript 编写，通过 Webpack 打包。主要用于游戏技能的动态修改和自定义实现。

### 技术栈
- **语言**: TypeScript
- **Hook框架**: Frida
- **构建工具**: Webpack
- **目标环境**: Node.js

## 2. 目录结构规范

```
skill_c5/
├── src/
│   ├── base/                    # 基础框架类（禁止修改）
│   │   ├── HookFuncCore.ts     # Hook核心函数
│   │   ├── PointerClass.ts      # 指针操作基类
│   │   └── skill/
│   │       ├── BaseHookSkillStub.ts  # 技能Hook基类
│   │       ├── Skill.ts              # 技能对象
│   │       ├── SPlayer.ts            # 玩家对象
│   │       └── ...
│   ├── skills/                  # 技能实现目录（主要开发区域）
│   │   ├── QingYunSkillList.ts # 青云技能列表
│   │   ├── TongYongSkillList.ts # 通用技能列表
│   │   └── [其他职业]SkillList.ts
│   └── main.ts                 # 入口文件
├── doc/                        # 参考图片目录
│   └── 参考/
│       ├── 青云/
│       ├── 合欢/
│       └── 通用/
└── dist/                       # 编译输出目录
```

## 3. 技能实现规范

### 3.1 类命名规范

- **技能类命名**: `Skill{技能ID}`
- **示例**: `Skill223`, `Skill460`, `Skill226`
- **技能列表类命名**: `{职业名}SkillList`
- **示例**: `QingYunSkillList`, `TongYongSkillList`

### 3.2 技能类结构模板

```typescript
/**
 * {技能ID} {技能名称}   {最大等级}
 * {技能描述第一行}
 * {技能描述第二行}
 * {技能描述第三行}
 */
class Skill{技能ID} extends BaseHookSkillStub {

    constructor() {
        super({技能ID});
    }

    // 根据需要重写以下方法
    GetCooldowntime(stub: NativePointer, skill: Skill, originFunc: NativeFunction<number, NativePointer[]>): number {
        // 返回冷却时间（毫秒）
        return 2000;
    }

    GetExecutetime(stub: NativePointer, skill: Skill, originFunc: NativeFunction<number, NativePointer[]>): number {
        // 返回施法时间（毫秒）
        return 1000;
    }

    Calculate2(stub: NativePointer, skill: Skill, originFunc: NativeFunction<void, NativePointer[]>): void {
        // 第2段伤害计算
        const player = skill.GetPlayerNice();
        skill.SetPlus(基础值 + skill.GetLevel() * 每级增长);
        player.SetPerform(1);
    }

    StateAttack(stub: NativePointer, skill: Skill, originFunc: NativeFunction<void, NativePointer[]>): boolean {
        // 状态攻击效果（每个State计算完都会执行）
        const player = skill.GetPlayerNice();
        // 设置状态效果
        return true;
    }

    BlessMe(stub: NativePointer, skill: Skill, originFunc: NativeFunction<void, NativePointer[]>): boolean {
        // 自身祝福效果
        const player = skill.GetPlayerNice();
        // 设置祝福效果
        return true;
    }

    TakeEffect(stub: NativePointer, skill: Skill, originFunc: NativeFunction<void, NativePointer[]>): boolean {
        // 被动/法阵效果
        const player = skill.GetPlayerNice();
        // 设置被动效果
        return true;
    }
}
```

### 3.3 注释规范

每个技能类必须包含完整的注释，格式如下：

```typescript
/**
 * {技能ID} {技能名称}   {最大等级}
 * {技能类型和范围描述}
 * {伤害/效果描述}
 * {特殊效果描述}
 */
```

**示例**:
```typescript
/**
 * 223 寒冰咒   9
 * 单体攻击10.7米，施法时间1秒，技能冷却2秒。
 * 攻击目标1次，附加53/85点攻击力。
 * 有48%/72%几率使目标被冰冻，持续4/12秒：降低其移动速度22%/46%
 */
```

### 3.4 方法重写规范

#### 必须重写的方法
- 如果技能有冷却时间，必须重写 `GetCooldowntime()`
- 如果技能有施法时间，必须重写 `GetExecutetime()`
- 如果技能有伤害计算，必须重写对应的 `Calculate{段数}()`
- 如果技能有状态效果，必须重写 `StateAttack()`
- 如果技能有自身祝福，必须重写 `BlessMe()`
- 如果技能是被动，必须重写 `TakeEffect()`

#### 可重写的其他方法
- `GetHpcost()` - 气血消耗
- `GetMpcost()` - 真气消耗
- `GetDpcost()` - 元力消耗
- `GetRadius()` - 攻击半径
- `GetAttackdistance()` - 攻击距离
- `GetTime{段数}()` - 各段执行时间
- 等等

## 4. 代码风格规范

### 4.1 缩进和格式
- 使用 **4个空格** 缩进（不使用Tab）
- 大括号 `{` 与类/函数名同一行
- 方法之间留一个空行
- 行尾不加分号（可选，但保持一致性）

### 4.2 变量命名
- **驼峰命名法** (camelCase)
- 变量名要有意义，避免使用单字母变量（循环变量除外）
- 常量使用全大写，单词间用下划线

**示例**:
```typescript
const player = skill.GetPlayerNice();
const skillLevel = skill.GetLevel();
const maxAtk = player.GetMaxatk();
```

### 4.3 代码组织
- 每个技能类独立，互不依赖
- 相关操作放在同一个方法内
- 复杂计算使用中间变量提高可读性

## 5. API使用规范

### 5.1 Skill对象常用API

#### 获取信息
```typescript
skill.GetId()                    // 获取技能ID
skill.GetLevel()                 // 获取技能等级
skill.GetPlayerNice()            // 获取玩家对象（推荐）
skill.GetVictimNice()            // 获取目标对象
```

#### 设置伤害相关
```typescript
skill.SetPlus(value)             // 设置附加攻击力
skill.SetRatio(value)             // 设置伤害倍率（1.0为基础）
skill.SetPlus2(value)            // 设置附加攻击力2
skill.SetCrit(value)             // 设置附加暴击率
skill.SetCrithurt(value)         // 设置附加爆伤
```

#### 设置技能消耗
```typescript
skill.GetMpcost()                // 获取真气消耗（重写）
skill.GetHpcost()                // 获取气血消耗（重写）
skill.GetDpcost()                // 获取元力消耗（重写）
```

### 5.2 SPlayer对象常用API

#### 获取玩家属性
```typescript
player.GetMp()                   // 获取当前真气
player.GetMaxmp()                // 获取最大真气
player.GetHp()                   // 获取当前气血
player.GetMaxhp()                // 获取最大气血
player.GetMaxatk()               // 获取最大攻击力
player.GetLevel()                 // 获取玩家等级
```

#### 设置状态效果

**冰冻和减速**:
```typescript
// SetFrozen(概率, 比率, 持续时间毫秒, buffId)
player.SetFrozen(45 + skill.GetLevel() * 3, 1, 3000, 1);

// SetSlow(概率, 减速比例, 持续时间毫秒, buffId)
// 概率: -1表示100%，具体数值表示百分比
// 减速比例: 0.19表示减速19%
player.SetSlow(-1, 0.19 + skill.GetLevel() * 0.03, 3000, 1);
```

**攻击力提升**:
```typescript
// SetAddattack(概率, 持续时间毫秒, 攻击力增加值, buffId)
player.SetAddattack(120, 3000, 6 * skill.GetLevel(), 1);
```

**防御提升**:
```typescript
// SetIncdefence(概率, 持续时间毫秒, 防御提升比例, buffId)
player.SetIncdefence(120, 30000, 0.01 * skill.GetLevel(), 1);
```

**移动速度**:
```typescript
// SetAddspeed(概率, 持续时间毫秒, 速度增加值(米/秒), buffId)
player.SetAddspeed(100, 16000, 2.5, 1);
```

**真气回复速度**:
```typescript
// SetIncmpgen(回复速度比例, 持续时间毫秒, buffId)
player.SetIncmpgen(0.12, 300000, 1);
```

**真气上限提升**:
```typescript
// SetZhaoqi(概率, 比例, 数值, 持续时间毫秒, buffId)
player.SetZhaoqi(120, 0.05 * skill.GetLevel(), 0, 1800000, 1);
```

**魔法护盾**:
```typescript
// SetMagicshield(吸收伤害比例, 最大吸收量, 持续时间毫秒)
player.SetMagicshield(0.08 + skill.GetLevel() * 0.01, 2 * player.GetMaxmp(), 30000);
```

**被动属性**:
```typescript
// 永久增加真气上限
player.SetPasaddmp(300 * skill.GetLevel());

// 永久增加眩晕抗性
player.SetPasadddizzy(5 * skill.GetLevel());

// 永久增加真气回复速度
player.SetPasincmpgen(0.3 * skill.GetLevel());

// 永久增加定身抗性
player.SetPasaddanti(15 * skill.GetLevel());
```

#### 执行状态
```typescript
// 必须调用，表示开始执行技能效果，1表示会扣除技能消耗，0表示不扣除技能消耗
//仅在Calculate2时传1
player.SetPerform(1);
```

#### 清除冷却
```typescript
// SetClearcooldown(技能ID1, 技能ID2, ...)
player.SetClearcooldown(233, 235, 239);
```

### 5.3 时间单位规范

- **所有时间参数单位均为毫秒**
- 冷却时间、施法时间、持续时间都使用毫秒

**示例**:
```typescript
return 2000;        // 2秒冷却
return 60000;       // 60秒冷却
return 120000;      // 120秒冷却
```

### 5.4 概率设置规范

- `-1` 表示跟随上一个状态的概率
- `0-100` 表示具体百分比
- 通常使用 `120` 表示 100%（兼容性处理）

**示例**:
```typescript
player.SetFrozen(100, 1, 3000, 1);    // 100%概率
player.SetFrozen(45, 1, 3000, 1);     // 45%概率
player.SetFrozen(-1, 1, 3000, 1);     // 跟随上一个状态的概率
```

## 6. 常见实现模式

### 6.1 等级成长公式

大多数技能效果都是基于等级的线性增长：

```typescript
// 基础值 + 每级增长值 * (等级 - 1)
const baseValue = 53;
const perLevel = 4;
skill.SetPlus(baseValue + (skill.GetLevel() - 1) * perLevel);

// 或者简化为：基础值 + 等级 * 每级增长（如果从1级开始）
skill.SetPlus(49 + skill.GetLevel() * 4);
```

### 6.2 条件判断

```typescript
// 真气大于95%时追加效果
const mp = player.GetMp();
const maxmp = player.GetMaxmp();
if (mp / maxmp > 0.95) {
    skill.SetRatio(1 + 0.04);
}

// 怪物目标判断
if (player.GetTypeIsMob) {
    player.SetRepel(33, 10);
}
```

### 6.3 多段伤害

```typescript
// 第1段
Calculate1(stub: NativePointer, skill: Skill, originFunc: NativeFunction<void, NativePointer[]>): void {
    skill.SetPlus(第一段伤害);
}

// 第2段
Calculate2(stub: NativePointer, skill: Skill, originFunc: NativeFunction<void, NativePointer[]>): void {
    skill.SetPlus(第二段伤害);
}

// 设置各段执行时间
GetTime1(...): number {
    return 800;  // 第1段的执行时间800ms
}

GetTime2(...): number {
    return 200;  // 第2段的执行时间200ms
}
```

### 6.4 被动技能

```typescript
TakeEffect(stub: NativePointer, skill: Skill, originFunc: NativeFunction<void, NativePointer[]>): boolean {
    const player = skill.GetPlayerNice();
    
    // 永久属性提升
    player.SetPasaddmp(300 * skill.GetLevel());
    player.SetPasadddizzy(5 * skill.GetLevel());
    
    return true;
}
```

## 7. 注意事项

### 7.1 必须调用SetPerform

在 `Calculate` 方法中，**必须**调用 `player.SetPerform(X)`，否则技能不会执行。

```typescript
Calculate2(...): void {
    const player = skill.GetPlayerNice();
    skill.SetPlus(100);
    player.SetPerform(1);  // 必须调用
}
```

### 7.2 返回值规范

- `GetCooldowntime()`、`GetExecutetime()` 等返回数值的方法，必须返回 `number`
- `StateAttack()`、`BlessMe()`、`TakeEffect()` 等返回布尔值的方法，通常返回 `true`

### 7.3 技能等级获取

始终使用 `skill.GetLevel()` 获取技能等级，不要使用硬编码值。

### 7.4 单位换算

- 时间：秒 → 毫秒（乘以1000）
- 百分比：45% → 0.45（用于倍率）或 45（用于概率）
- 速度：米/秒（直接使用）

### 7.5 未实现功能标记

如果某些功能暂时无法实现，使用注释标记：

```typescript
/**
 * @未实现 若自身真气上限高于目标时，则目标4秒内无法通过吃药来回复真气。
 */
```

## 8. 图片识别开发流程

### 8.1 图片分析步骤

1. **识别技能基本信息**
   - 技能ID
   - 技能名称
   - 最大等级
   - 技能类型（主动/被动/祝福等）

2. **提取技能描述**
   - 攻击类型和范围
   - 施法时间和冷却时间
   - 伤害数值和成长公式
   - 特殊效果描述

3. **转换为代码**
   - 根据描述确定需要重写的方法
   - 计算等级成长公式
   - 设置状态效果参数

### 8.2 常见描述模式

- **"单体攻击X米"** → 需要在注释中说明
- **"群体攻击，自身周围X米"** → 需要在注释中说明
- **"施法时间X秒，技能冷却X秒"** → 重写 `GetExecutetime()` 和 `GetCooldowntime()`
- **"附加X/Y点攻击力"** → 在 `Calculate` 中使用 `SetPlus()`，计算成长公式
- **"有X%/Y%几率使目标被冰冻"** → 在 `StateAttack()` 中使用 `SetFrozen()`
- **"永久增加"** → 在 `TakeEffect()` 中使用 `SetPas*()` 系列方法

## 9. 代码审查清单

在提交代码前，检查以下事项：

- [ ] 技能类注释完整，包含技能ID、名称、等级、描述
- [ ] 所有时间参数使用毫秒单位
- [ ] `Calculate` 方法中调用了 `player.SetPerform(X)`
- [ ] 等级成长公式正确计算
- [ ] 概率设置正确（-1表示100%，或具体百分比）
- [ ] 代码格式统一（4空格缩进）
- [ ] 变量命名清晰有意义
- [ ] 未实现功能已标记注释
- [ ] 所有方法都有适当的返回值

## 10. 示例代码

完整的技能实现示例：

```typescript
/**
 * 223 寒冰咒   9
 * 单体攻击10.7米，施法时间1秒，技能冷却2秒。
 * 攻击目标1次，附加53/85点攻击力。
 * 有48%/72%几率使目标被冰冻，持续4/12秒：降低其移动速度22%/46%
 */
class Skill223 extends BaseHookSkillStub {

    constructor() {
        super(223);
    }

    GetCooldowntime(stub: NativePointer, skill: Skill, originFunc: NativeFunction<number, NativePointer[]>): number {
        return 2000;  // 2秒冷却
    }

    Calculate2(stub: NativePointer, skill: Skill, originFunc: NativeFunction<void, NativePointer[]>): void {
        const player = skill.GetPlayerNice();
        // 基础53，每级增长4，等级1时为53，等级9时为53+8*4=85
        skill.SetPlus(49 + skill.GetLevel() * 4);
        player.SetPerform(1);
    }

    StateAttack(stub: NativePointer, skill: Skill, originFunc: NativeFunction<void, NativePointer[]>): boolean {
        const player = skill.GetPlayerNice();
        const level = skill.GetLevel();

        // 冰冻概率：48% + (等级-1) * 3% = 48% + 8*3% = 72%
        // 持续时间：4秒 + (等级-1) * 1秒 = 4秒 + 8秒 = 12秒
        player.SetFrozen(45 + level * 3, 1, 3100 + level * 1000, 1);
        
        // 减速：22% + (等级-1) * 3% = 22% + 8*3% = 46%
        player.SetSlow(-1, 0.19 + level * 0.03, 3100 + level * 1000, 1);

        return true;
    }
}
```

---

**最后更新**: 2025-01-XX  
**维护者**: AI Assistant

